name: Update Managerial Report Media

on:
  workflow_dispatch:
    inputs:
      commit_changes:
        description: "Commit generated media files to current branch"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write

jobs:
  capture-media:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
      uses: actions/checkout@v4

      - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"
        cache-dependency-path: ui_web/package-lock.json

      - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

      - name: Install UI deps
      run: npm ci --prefix ui_web

      - name: Install Python deps
      run: |
        python -m pip install --upgrade pip
        pip install selenium pillow

      - name: Generate report media assets
      run: python tools/docs/capture_managerial_report_media.py --ui-url http://127.0.0.1:3200 --start-server

      - name: Upload assets artifact
      uses: actions/upload-artifact@v4
      with:
        name: managerial-report-media
        path: |
          docs/readme_images/ui-crm-relatorio-gerencial.png
          docs/readme_images/ui-crm-relatorio-gerencial-loop.gif
        if-no-files-found: error

      - name: Commit generated assets
      if: ${{ github.event.inputs.commit_changes == 'true' }}
      run: |
        git add docs/readme_images/ui-crm-relatorio-gerencial.png docs/readme_images/ui-crm-relatorio-gerencial-loop.gif
        if git diff --cached --quiet; then
          echo "No media changes to commit."
          exit 0
        fi
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "docs: refresh managerial report media assets"
        git push

